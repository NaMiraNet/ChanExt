name: Extract Telegram Channels

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      folder_link:
        description: 'Telegram folder link (optional - will use folder.txt if empty)'
        required: false
        type: string
  
  # Trigger when folder.txt changes
  push:
    paths:
      - 'folder.txt'
    branches:
      - main
      - master
  
  # Optional: Schedule to run daily
  # schedule:
  #   - cron: '0 0 * * *'  # Run daily at midnight UTC

jobs:
  extract-channels:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Need this to push back to repo
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install telethon
      
      - name: Create folder.txt if manual input provided
        if: ${{ github.event.inputs.folder_link != '' }}
        run: |
          echo "${{ github.event.inputs.folder_link }}" > folder.txt
          echo "Manual folder link provided: ${{ github.event.inputs.folder_link }}"
      
      - name: Check folder.txt exists
        run: |
          if [ ! -f folder.txt ]; then
            echo "Error: folder.txt not found!"
            exit 1
          fi
          echo "Folder link: $(cat folder.txt)"
      
      - name: Create results directory
        run: |
          mkdir -p results
      
      - name: Extract Telegram channels
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_STRING_SESSION: ${{ secrets.TELEGRAM_STRING_SESSION }}
        run: |
          echo "Starting channel extraction..."
          python telegram_extractor.py
          
          # Check if channels.txt was created
          if [ -f channels.txt ]; then
            echo "✅ Extraction successful!"
            echo "Found $(wc -l < channels.txt) channels"
            
            # Copy to results folder with timestamp
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            cp channels.txt "results/channels_${TIMESTAMP}.txt"
            cp channels.txt "results/channels_latest.txt"
            
            echo "Results saved to results/ folder"
          else
            echo "❌ No channels found or extraction failed"
            touch "results/channels_latest.txt"
          fi
      
      - name: Display results
        run: |
          echo "=== EXTRACTION RESULTS ==="
          if [ -f channels.txt ] && [ -s channels.txt ]; then
            echo "Channels found:"
            cat channels.txt
          else
            echo "No channels found"
          fi
      
      - name: Commit and push results
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add results
          git add results/
          
          # Also update channels.txt in root if it exists
          if [ -f channels.txt ]; then
            git add channels.txt
          fi
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Create commit message
            TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S UTC")
            FOLDER_LINK=$(cat folder.txt)
            
            if [ -f channels.txt ] && [ -s channels.txt ]; then
              CHANNEL_COUNT=$(wc -l < channels.txt)
              COMMIT_MSG="📡 Extracted ${CHANNEL_COUNT} channels - ${TIMESTAMP}
          
          Folder: ${FOLDER_LINK}
          Triggered by: ${{ github.event_name }}"
            else
              COMMIT_MSG="❌ Channel extraction failed - ${TIMESTAMP}
          
          Folder: ${FOLDER_LINK}
          Triggered by: ${{ github.event_name }}"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
            
            echo "✅ Results committed and pushed to repository"
          fi
      
      - name: Upload results as artifact
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: telegram-channels
          path: |
            channels.txt
            results/
          retention-days: 30
      
      - name: Create job summary
        if: always()
        run: |
          echo "## 📡 Telegram Channel Extraction Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Folder Link:** $(cat folder.txt)" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f channels.txt ] && [ -s channels.txt ]; then
            CHANNEL_COUNT=$(wc -l < channels.txt)
            echo "**Status:** ✅ Success" >> $GITHUB_STEP_SUMMARY
            echo "**Channels Found:** ${CHANNEL_COUNT}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Channels:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat channels.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ❌ Failed or no channels found" >> $GITHUB_STEP_SUMMARY
          fi